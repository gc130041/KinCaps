<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Historial de Compras | KINCAPS</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="icon" th:href="@{/img/Logo/logonobg.png}" type="image/x-icon">
    <link rel="stylesheet" th:href="@{/style/catalogo.css}">
</head>
<body class="d-flex flex-column min-vh-100">
    <header>
        <nav class="navbar navbar-expand-lg bg-header navbar-dark fixed-top">
            <div class="container-fluid">
                <a th:href="@{/gorras}" class="navbar-brand fw-bold">
                    <img th:src="@{/img/Logo/logotipo.png}" style="width: 5vh;" alt="Logotipo.png"/> Historial de Compras
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#menuNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="menuNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a th:href="@{/gorras/catalogo}" class="btn btn-outline-light">Volver al Catálogo</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>
    </header>

    <main class="container" style="padding-top: 80px; padding-bottom: 40px;">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4 border-bottom pb-2">Mis Pedidos</h1>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th style="background: linear-gradient(90deg,#002e71,#06458a); border-color: transparent; color:white;">Pedido #</th>
                        <th style="background: linear-gradient(90deg,#06458a,#0b5da3); border-color: transparent; color:white;">Fecha</th>
                        <th style="background: linear-gradient(90deg,#0b5da3,#0f75bd); border-color: transparent; color:white;">Total</th>
                        <th style="background: linear-gradient(90deg,#0f75bd,#0f86d4); border-color: transparent; color:white;">Estado</th>
                        <th style="background-color: #0f86d4; border-color: transparent; color:white;" class="text-center">Detalles</th>
                    </tr>
                </thead>
                <tbody>
                    <tr th:if="${#lists.isEmpty(listaPedidos)}">
                        <td colspan="5" class="text-center p-4">
                            Aún no has realizado ninguna compra. ¡Explora nuestro <a th:href="@{/gorras/catalogo}">catálogo</a>!
                        </td>
                    </tr>
                    <th:block th:each="pedido : ${listaPedidos}">
                        <tr>
                            <th scope="row" th:text="'KIN-2025-' + ${pedido.idCarrito}"></th>
                            <td th:text="${#temporals.format(pedido.fechaCreacion, 'dd ''de'' MMMM, yyyy')}"></td>
                            <td>
                                <span th:with="totalPedido=${pedido.detalles.![cantidad * precioUnitario.doubleValue()].![#aggregates.sum(#this)]}"
                                      th:text="'Q' + ${#numbers.formatDecimal(totalPedido, 1, 'COMMA', 2, 'POINT')}"></span>
                            </td>
                            <td>
                                <span th:switch="${pedido.estado.name()}" class="badge"
                                      th:classappend="${pedido.estado.name() == 'PAGADO'} ? 'bg-success' : 'bg-warning text-dark'">
                                    <span th:case="'PAGADO'">Pagado</span>
                                    <span th:case="'INACTIVO'">Cancelado</span>
                                    <span th:case="*" th:text="${pedido.estado.name()}"></span>
                                </span>
                            </td>
                            <td class="text-center">
                                <a class="btn btn-primary btn-sm" data-bs-toggle="collapse" th:href="${'#detalle-' + pedido.idCarrito}" role="button">
                                    Ver Detalles
                                </a>
                            </td>
                        </tr>
                        <tr class="collapse" th:id="${'detalle-' + pedido.idCarrito}">
                            <td colspan="5" class="p-0">
                                <div class="p-3" style="background-color: #f8f9fa;">
                                    <h6 class="mb-3 fw-bold" th:text="'Productos del Pedido KIN-2025-' + ${pedido.idCarrito}"></h6>
                                    <div th:each="detalle : ${pedido.detalles}" class="d-flex justify-content-between border-bottom pb-2 mb-2">
                                        <span th:text="${detalle.gorra.nombreGorra}"></span>
                                        <span th:text="'Cantidad: ' + ${detalle.cantidad}"></span>
                                        <span class="fw-semibold" th:text="'Q' + ${#numbers.formatDecimal(detalle.precioUnitario, 1, 'COMMA', 2, 'POINT')}"></span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </th:block>
                </tbody>
            </table>
        </div>
    </main>
    <footer class="bg-header text-white text-center py-4 mt-auto">
        <p class="mb-1">2025 KINCAPS. Todos los derechos reservados.</p>
        <small>
            <a th:href="@{/politica}" class="text-white text-decoration-none me-3">Política de Privacidad</a>
            <a th:href="@{/terminos}" class="text-white text-decoration-none">Términos y Condiciones</a>
        </small>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>